<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Print3 Assistant</title>

    <!-- Tailwind (play‑CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (submit arrow) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <!-- Google model‑viewer for 3‑D preview -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      .transition-shape {
        transition: border-radius 0.2s ease, background-color 0.2s ease;
      }
      .prompt-textarea {
        overflow-y: hidden; /* cap growth */
      }

      /* ─── Floating slideshow animation ─── */
      @keyframes floatY {
        0%   { transform: translateY(-5%); }
        50%  { transform: translateY(5%);  }
        100% { transform: translateY(-5%); }
      }
      .slide-img {
        @apply absolute inset-0 object-contain opacity-0 pointer-events-none;
        animation: floatY 7s ease-in-out infinite;
        transition: opacity 1s ease-in-out;
      }
      .slide-img.show { opacity: 1; }
    </style>
  </head>
  <body class="bg-[#1A1A1D] text-white font-sans flex flex-col">
    <!-- ╔════════ HEADER ════════╗ -->
    <header class="flex items-center justify-between py-4 px-6">
      <img src="img/text-logo.png" alt="Print3 wordmark" class="h-10 w-auto" />
    </header>

    <!-- ╔════════ MAIN ════════╗ -->
    <main class="flex-1 flex flex-col items-center justify-center gap-8 px-4 lg:px-16">
      <!-- 3‑D Preview Card + floating slideshow overlay → keeps grey bg -->
      <section id="preview-wrapper" class="relative w-full max-w-lg h-80 bg-[#2A2A2E] rounded-3xl overflow-hidden flex items-center justify-center">
        <!-- static grey placeholder (hidden when model rendered) -->
        <img id="preview-img" src="https://placehold.co/600x400/2A2A2E/2A2A2E?text=" alt="" class="object-contain h-full w-full" />

        <!-- Google 3‑D viewer (hidden until src set) -->
        <model-viewer id="viewer" src="" alt="Generated 3‑D Model" camera-controls auto-rotate style="width:100%;height:100%;display:none;"></model-viewer>

        <!-- Floating slideshow layer (images live in /img folder) -->
        <div id="slide-layer" class="absolute inset-0 flex items-center justify-center">
          <img src="img/slide1.png" alt="slideshow image 1" class="slide-img show" />
          <img src="img/slide2.png" alt="slideshow image 2" class="slide-img" />
          <img src="img/slide3.png" alt="slideshow image 3" class="slide-img" />
          <img src="img/slide4.png" alt="slideshow image 4" class="slide-img" />
          <img src="img/slide5.png" alt="slideshow image 5" class="slide-img" />
          <img src="img/slide6.png" alt="slideshow image 6" class="slide-img" />
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-lg hidden">Generating…</div>
      </section>

      <!-- Prompt & Upload Panel -->
      <section class="w-full max-w-xl">
        <div class="flex flex-col items-center text-center">
          <img src="img/box-logo.png" alt="Print3 cube logo" class="w-32 h-32 mb-4" />
          <h1 class="text-3xl font-semibold mb-6">Make your world.</h1>

          <!-- Prompt row -->
          <div class="flex items-center w-full max-w-xl gap-4">
            <div class="flex-1 bg-[#2A2A2E] rounded-3xl px-5 py-2">
              <textarea id="promptInput" placeholder="Describe your 3‑D print request…" class="prompt-textarea w-full bg-transparent resize-none text-lg placeholder-gray-500 focus:outline-none" rows="1"></textarea>
            </div>
            <button id="submit-button" class="w-12 h-12 flex items-center justify-center bg-white rounded-full transition-shape">
              <i id="submit-icon" class="fas fa-arrow-up text-xl text-[#1A1A1D]"></i>
            </button>
          </div>

          <!-- Upload row -->
          <div class="mt-4 w-full max-w-xl flex gap-4">
            <div class="w-1/3">
              <input type="file" id="uploadInput" accept="image/*" multiple class="hidden" />
              <label for="uploadInput" class="block w-full bg-[#2A2A2E] rounded-3xl px-5 py-3 text-lg text-center cursor-pointer hover:bg-[#3A3A3E] transition-shape">Upload Images</label>
            </div>
            <div id="image-preview-area" class="hidden flex-1 bg-[#2A2A2E] rounded-3xl min-h-[6rem] max-h-56 flex flex-wrap content-start gap-3 px-4 py-3 overflow-y-auto"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- ╔════════ SCRIPTS ════════╗ -->
    <script>
      /* ========== Config ========= */
      const API_BASE = "https://print3.com";
      const SLIDE_INTERVAL = 4000; // ms

      /* ========== Slideshow ========= */
      const slides = Array.from(document.querySelectorAll("#slide-layer .slide-img"));
      let slideIdx = 0;
      setInterval(() => {
        slides[slideIdx].classList.remove("show");
        slideIdx = (slideIdx + 1) % slides.length;
        slides[slideIdx].classList.add("show");
      }, SLIDE_INTERVAL);

      /* ======= Existing prompt & upload JS (unchanged) ======= */
      const uploadedFiles = [];
      const promptInput = document.getElementById("promptInput");
      const submitBtn = document.getElementById("submit-button");
      const submitIcon = document.getElementById("submit-icon");
      const uploadInput = document.getElementById("uploadInput");
      const imagePreviewArea = document.getElementById("image-preview-area");
      const previewImg = document.getElementById("preview-img");
      const viewer = document.getElementById("viewer");
      const loadingOverlay = document.getElementById("loading-overlay");

      function autoGrow(el) {
        el.style.height = "auto";
        const lh = parseFloat(getComputedStyle(el).lineHeight);
        const max = lh * 9;
        el.style.height = Math.min(el.scrollHeight, max) + "px";
        el.style.overflowY = el.scrollHeight > max ? "auto" : "hidden";
      }
      promptInput.addEventListener("input", () => autoGrow(promptInput));

      submitBtn.addEventListener("click", async () => {
        const prompt = promptInput.value.trim();
        if (!prompt) return;
        submitIcon.classList.replace("fa-arrow-up", "fa-stop");
        loadingOverlay.classList.remove("hidden");
        try {
          const shapeRes = await fetch(`${API_BASE}/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });
          if (!shapeRes.ok) throw new Error();
          const { mesh_url } = await shapeRes.json();
          const paintRes = await fetch(`${API_BASE}/paint`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mesh_url, prompt })
          });
          if (!paintRes.ok) throw new Error();
          const { textured_mesh_url } = await paintRes.json();
          previewImg.classList.add("hidden");
          imagePreviewArea.classList.add("hidden");
          viewer.src = textured_mesh_url;
          viewer.style.display = "block";
        } catch (err) {
          alert("Generation failed");
        } finally {
          loadingOverlay.classList.add("hidden");
          submitIcon.classList.replace("fa-stop", "fa-arrow-up");
        }
      });

      uploadInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        imagePreviewArea.classList.remove("hidden");
        viewer.style.display = "none";
        previewImg.classList.add("hidden");
        files.forEach((file) => {
          uploadedFiles.push(file);
          const idx = uploadedFiles.length - 1;
          const url = URL.createObjectURL(file);
          const wrapper = document.createElement("div");
          wrapper.className = "relative inline-block";
          wrapper.dataset.idx = idx;
          const img = document.createElement("img");
          img.src = url;
          img.alt = `upload ${idx + 1}`;
          img.className = "object-cover w-24 h-24 rounded-md shadow-md";
          const del = document.createElement("button");
          del.type = "button";
          del.innerText = "✕";
          del.className = "absolute top-0 right-0 translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-white text-black flex items-center justify-center border border-black text-xs";
          del.addEventListener("click", () => {
            uploadedFiles[idx] = null;
            wrapper.remove();
            if (!imagePreviewArea.querySelector("img")) {
              imagePreviewArea.classList.add("hidden");
              previewImg.classList.remove("hidden");
            }
          });
          wrapper.appendChild(img);
          wrapper.appendChild(del);
          imagePreviewArea.appendChild(wrapper);
        });
      });
    </script>
  </body>
</html>
