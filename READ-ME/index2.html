<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Print3 Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <!-- 3D Model Viewer -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      .transition-shape {
        transition: border-radius 0.2s ease, background-color 0.2s ease;
      }
      .prompt-textarea {
        overflow-y: hidden;
        padding-top: 0;
        padding-bottom: 0;
      }
      @keyframes floatY {
        0%,100% {transform: translateY(-4%);} 50%{transform: translateY(4%);}
      }
      .slide-img{@apply absolute inset-0 object-contain opacity-0 pointer-events-none;animation:floatY 7s ease-in-out infinite;transition:opacity 1s ease-in-out;}
      .slide-img.show{opacity:1;}
    </style>
  </head>
  <body class="bg-[#1A1A1D] text-white font-sans flex flex-col">
    <header class="flex items-center justify-between py-4 px-6">
      <img src="img/textlogo.png" alt="print3 logo" class="h-10 w-auto"/>
    </header>
    <main class="flex-1 flex flex-col items-center justify-center gap-16 px-4 lg:px-16">
      <section id="preview-wrapper" class="relative w-full max-w-lg h-80 bg-[#2A2A2E] border border-white/10 rounded-3xl overflow-hidden">
        <img id="preview-img" src="https://placehold.co/600x400/2A2A2E/2A2A2E?text=" alt="Preview" class="object-contain h-full w-full"/>
        <model-viewer id="viewer" camera-controls auto-rotate style="display:none;width:100%;height:100%;"></model-viewer>
        <div id="slide-layer" class="absolute inset-0 flex items-center justify-center" style="display:none;">
          <img src="img/slide1.png" class="slide-img show"/>
          <img src="img/slide2.png" class="slide-img"/>
          <img src="img/slide3.png" class="slide-img"/>
          <img src="img/slide4.png" class="slide-img"/>
          <img src="img/slide5.png" class="slide-img"/>
          <img src="img/slide6.png" class="slide-img"/>
        </div>
        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-[#2A2A2E]/80" style="display:none;">
          <div class="h-10 w-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        </div>
      </section>
      <section class="w-full max-w-xl">
        <div class="flex flex-col items-center text-center">
          <img src="img/boxlogo.png" class="w-32 h-auto mb-8"/>
          <h1 class="text-3xl font-semibold mb-8">Make your world.</h1>
          <div class="flex items-center w-full gap-4">
            <div class="flex items-center flex-1 bg-[#2A2A2E] border border-white/10 rounded-3xl px-5 py-2">
              <textarea id="promptInput" rows="1" placeholder="Describe your 3D print request…" class="prompt-textarea flex-1 bg-transparent resize-none text-lg leading-[1.75rem] p-0 placeholder-gray-500 focus:outline-none"></textarea>
            </div>
            <button id="submit-button" class="w-12 h-12 flex items-center justify-center bg-white rounded-full transition-shape"><i id="submit-icon" class="fas fa-arrow-up text-xl text-[#1A1A1D]"></i></button>
          </div>
          <div class="mt-4 w-full flex gap-4">
            <div class="flex-none">
              <input type="file" id="uploadInput" accept="image/*" multiple class="hidden"/>
              <label for="uploadInput" class="inline-block bg-[#2A2A2E] border border-white/10 rounded-3xl px-5 py-2 flex items-center justify-center text-lg cursor-pointer hover:bg-[#3A3A3E] transition-shape">Upload Images</label>
            </div>
            <div id="image-preview-area" class="hidden flex-1 bg-[#2A2A2E] border border-white/10 rounded-3xl min-h-[6rem] max-h-56 flex flex-wrap content-start gap-3 px-4 py-3 overflow-y-auto"></div>
          </div>
        </div>
      </section>
    </main>
    <script type="module">
      const API_BASE='/api';const SLIDE_INTERVAL=4000;const FALLBACK_GLB='https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      const refs={previewImg:document.getElementById('preview-img'),slides:document.querySelectorAll('#slide-layer .slide-img'),slideLayer:document.getElementById('slide-layer'),loader:document.getElementById('loader'),viewer:document.getElementById('viewer'),promptInput:document.getElementById('promptInput'),submitBtn:document.getElementById('submit-button'),submitIcon:document.getElementById('submit-icon'),uploadInput:document.getElementById('uploadInput'),imagePreviewArea:document.getElementById('image-preview-area')};
      function showLoader(){refs.previewImg.style.display='none';refs.slideLayer.style.display='none';refs.loader.style.display='flex';refs.viewer.style.display='none';}
      function showModel(){refs.previewImg.style.display='none';refs.slideLayer.style.display='none';refs.loader.style.display='none';refs.viewer.style.display='block';}
      let slideIndex=0;setInterval(()=>{refs.slides[slideIndex].classList.toggle('show');slideIndex=(slideIndex+1)%refs.slides.length;refs.slides[slideIndex].classList.toggle('show');},SLIDE_INTERVAL);
      function autoGrow(el){el.style.height='auto';const lh=parseFloat(getComputedStyle(el).lineHeight);const max=lh*9;el.style.height=Math.min(el.scrollHeight,max)+'px';el.style.overflowY=el.scrollHeight>max?'auto':'hidden';}
      refs.promptInput.addEventListener('input',()=>autoGrow(refs.promptInput));
      async function fetchGlb(prompt,files){try{const fd=new FormData();if(prompt)fd.append('prompt',prompt);files.forEach(f=>fd.append('images',f));const res=await fetch(`${API_BASE}/generate`,{method:'POST',body:fd});if(!res.ok)throw new Error(res.statusText);const {glb_url}=await res.json();return glb_url;}catch(e){console.warn('fallback',e);return FALLBACK_GLB;}}
      const uploadedFiles=[];
      refs.submitBtn.addEventListener('click',async()=>{const text=refs.promptInput.value.trim();if(!text&&uploadedFiles.length===0)return;refs.submitIcon.classList.replace('fa-arrow-up','fa-stop');showLoader();try{const url=await fetchGlb(text,uploadedFiles);refs.viewer.src=url;await refs.viewer.updateComplete;showModel();}finally{refs.submitIcon.classList.replace('fa-stop','fa-arrow-up');}});
      refs.uploadInput.addEventListener('change',e=>{const files=[...e.target.files];if(!files.length)return;uploadedFiles.length=0;uploadedFiles.push(...files);refs.imagePreviewArea.classList.remove('hidden');refs.imagePreviewArea.innerHTML='';files.forEach((file,i)=>{const url=URL.createObjectURL(file);const container=document.createElement('div');container.className='relative inline-block';const img=document.createElement('img');img.src=url;img.alt=`upload ${i+1}`;img.className='object-cover w-20 h-20 rounded-md shadow-md';const btn=document.createElement('button');btn.type='button';btn.textContent='✕';btn.className='absolute top-0 right-0 translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-white text-black border border-black text-xs';btn.addEventListener('click',()=>{const idx=uploadedFiles.indexOf(file);if(idx>-1){uploadedFiles.splice(idx,1);}container.remove();if(!refs.imagePreviewArea.querySelector('img'))refs.imagePreviewArea.classList.add('hidden');});container.append(img,btn);refs.imagePreviewArea.append(container);});});
    </script>
  </body>
</html>
